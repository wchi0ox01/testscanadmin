<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่าระบบ - ระบบเช็คชื่อวิทยาลัย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', 'Kanit', sans-serif; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .step-card { transition: all 0.3s ease; }
        .step-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="flex items-center justify-center space-x-4 mb-6">
                <div class="bg-blue-100 p-4 rounded-2xl">
                    <i data-lucide="settings" class="w-12 h-12 text-blue-600"></i>
                </div>
                <div>
                    <h1 class="text-4xl font-bold text-gray-800">ตั้งค่าระบบเช็คชื่อ</h1>
                    <p class="text-gray-600 mt-2 text-lg">ระบบเช็คชื่อวิทยาลัยผ่านการสแกนใบหน้า</p>
                </div>
            </div>
        </div>

        <!-- Setup Steps -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Step 1 -->
            <div class="step-card bg-white rounded-2xl shadow-lg p-6 text-center">
                <div class="bg-blue-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-2xl font-bold text-blue-600">1</span>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Deploy Backend</h3>
                <p class="text-gray-600 text-sm">
                    นำโค้ด Google Apps Script ไป Deploy เป็น Web App
                </p>
            </div>

            <!-- Step 2 -->
            <div class="step-card bg-white rounded-2xl shadow-lg p-6 text-center">
                <div class="bg-green-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-2xl font-bold text-green-600">2</span>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">คัดลอก URL</h3>
                <p class="text-gray-600 text-sm">
                    คัดลอก URL ที่ได้จากการ Deploy มาใส่ในฟอร์มด้านล่าง
                </p>
            </div>

            <!-- Step 3 -->
            <div class="step-card bg-white rounded-2xl shadow-lg p-6 text-center">
                <div class="bg-purple-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-2xl font-bold text-purple-600">3</span>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">เริ่มใช้งาน</h3>
                <p class="text-gray-600 text-sm">
                    ระบบพร้อมใช้งาน! สามารถเริ่มลงทะเบียนนักศึกษาได้เลย
                </p>
            </div>
        </div>

        <!-- Setup Form -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">ตั้งค่า Google Apps Script URL</h2>
            <p class="text-gray-600 text-center mb-8">กรุณานำ URL ของ Google Apps Script Web App ที่ได้จากการ Deploy มาวางที่นี่</p>
            
            <div class="max-w-2xl mx-auto">
                <!-- URL Input -->
                <div class="mb-6">
                    <label for="gas-url" class="block text-sm font-medium text-gray-700 mb-3">
                        Google Apps Script Web App URL:
                    </label>
                    <input 
                        type="url" 
                        id="gas-url" 
                        placeholder="https://script.google.com/macros/s/..." 
                        class="w-full border border-gray-300 rounded-xl px-4 py-4 text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                    >
                    <p class="text-sm text-gray-500 mt-2">
                        ตัวอย่าง: https://script.google.com/macros/s/ABC123/exec
                    </p>
                </div>

                <!-- Test Connection -->
                <div class="mb-6">
                    <button 
                        onclick="testConnection()" 
                        id="test-btn"
                        class="w-full bg-blue-600 text-white py-4 rounded-xl hover:bg-blue-700 transition-colors font-semibold text-lg flex items-center justify-center space-x-3"
                    >
                        <i data-lucide="wifi" class="w-6 h-6"></i>
                        <span>ทดสอบการเชื่อมต่อ</span>
                    </button>
                </div>

                <!-- Save Button -->
                <div>
                    <button 
                        onclick="saveGasUrl()" 
                        id="save-btn"
                        class="w-full bg-green-600 text-white py-4 rounded-xl hover:bg-green-700 transition-colors font-semibold text-lg flex items-center justify-center space-x-3 hidden"
                    >
                        <i data-lucide="save" class="w-6 h-6"></i>
                        <span>บันทึกและเริ่มต้นใช้งาน</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-6 mb-8">
            <h3 class="text-lg font-semibold text-yellow-800 mb-4 flex items-center space-x-2">
                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                <span>คำแนะนำการ Deploy Google Apps Script</span>
            </h3>
            <div class="space-y-3 text-yellow-700">
                <div class="flex items-start space-x-3">
                    <i data-lucide="check-circle" class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                    <p>ไปที่ Google Apps Script → Deploy → New deployment</p>
                </div>
                <div class="flex items-start space-x-3">
                    <i data-lucide="check-circle" class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                    <p>เลือกประเภท "Web app"</p>
                </div>
                <div class="flex items-start space-x-3">
                    <i data-lucide="check-circle" class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                    <p>ตั้งค่า "Execute as" เป็น "Me"</p>
                </div>
                <div class="flex items-start space-x-3">
                    <i data-lucide="check-circle" class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                    <p>ตั้งค่า "Who has access" เป็น "Anyone"</p>
                </div>
                <div class="flex items-start space-x-3">
                    <i data-lucide="check-circle" class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                    <p>กด Deploy และคัดลอก URL ที่ได้</p>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="register.html" class="bg-white rounded-2xl shadow-lg p-6 text-center hover:shadow-xl transition-shadow block">
                <i data-lucide="user-plus" class="w-8 h-8 text-blue-600 mx-auto mb-3"></i>
                <h4 class="font-semibold text-gray-800 mb-2">ลงทะเบียนนักศึกษา</h4>
                <p class="text-gray-600 text-sm">สำหรับนักศึกษาใหม่</p>
            </a>
            
            <a href="scan.html" class="bg-white rounded-2xl shadow-lg p-6 text-center hover:shadow-xl transition-shadow block">
                <i data-lucide="scan-face" class="w-8 h-8 text-green-600 mx-auto mb-3"></i>
                <h4 class="font-semibold text-gray-800 mb-2">สแกนใบหน้า</h4>
                <p class="text-gray-600 text-sm">เช็คชื่อประจำวัน</p>
            </a>
            
            <a href="admin-login.html" class="bg-white rounded-2xl shadow-lg p-6 text-center hover:shadow-xl transition-shadow block">
                <i data-lucide="shield" class="w-8 h-8 text-purple-600 mx-auto mb-3"></i>
                <h4 class="font-semibold text-gray-800 mb-2">ผู้ดูแลระบบ</h4>
                <p class="text-gray-600 text-sm">สำหรับครูและผู้ดูแล</p>
            </a>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-6 flex items-center space-x-4">
            <div class="loader w-8 h-8 rounded-full border-4 border-gray-200 border-t-blue-600"></div>
            <span class="text-gray-700" id="loading-text">กำลังทดสอบการเชื่อมต่อ...</span>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
            <div class="bg-green-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i data-lucide="check" class="w-8 h-8 text-green-600"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">ตั้งค่าสำเร็จ!</h3>
            <p class="text-gray-600 mb-6">ระบบพร้อมใช้งานแล้ว</p>
            <button onclick="redirectToApp()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                เริ่มใช้งานระบบ
            </button>
        </div>
    </div>

    <script>
        // Initialize icons
        lucide.createIcons();

        // Check if already configured
        window.onload = function() {
            const savedUrl = localStorage.getItem('gasWebAppUrl');
            if (savedUrl) {
                document.getElementById('gas-url').value = savedUrl;
                document.getElementById('save-btn').classList.remove('hidden');
            }
        };

        // Test connection to GAS
        async function testConnection() {
            const url = document.getElementById('gas-url').value.trim();
            const testBtn = document.getElementById('test-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');

            if (!url) {
                alert('กรุณากรอก URL ก่อนทดสอบ');
                return;
            }

            // Validate URL format
            if (!url.startsWith('https://script.google.com/macros/')) {
                alert('URL ไม่ถูกต้อง กรุณาตรวจสอบรูปแบบ URL\n\nตัวอย่าง: https://script.google.com/macros/s/ABC123/exec');
                return;
            }

            testBtn.disabled = true;
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'กำลังทดสอบการเชื่อมต่อ...';

            try {
                // Test with a simple API call
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        action: 'getStudents'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success !== undefined) {
                    // Connection successful
                    loadingText.textContent = 'การเชื่อมต่อสำเร็จ!';
                    setTimeout(() => {
                        loadingOverlay.classList.add('hidden');
                        document.getElementById('save-btn').classList.remove('hidden');
                        testBtn.innerHTML = `
                            <i data-lucide="check-circle" class="w-6 h-6"></i>
                            <span>การเชื่อมต่อสำเร็จ</span>
                        `;
                        testBtn.className = 'w-full bg-green-600 text-white py-4 rounded-xl font-semibold text-lg flex items-center justify-center space-x-3';
                        lucide.createIcons();
                    }, 1000);
                } else {
                    throw new Error('Response format incorrect');
                }

            } catch (error) {
                console.error('Connection test failed:', error);
                loadingText.textContent = 'การเชื่อมต่อล้มเหลว';
                
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    testBtn.disabled = false;
                    testBtn.innerHTML = `
                        <i data-lucide="wifi-off" class="w-6 h-6"></i>
                        <span>ทดสอบอีกครั้ง</span>
                    `;
                    testBtn.className = 'w-full bg-red-600 text-white py-4 rounded-xl hover:bg-red-700 transition-colors font-semibold text-lg flex items-center justify-center space-x-3';
                    
                    let errorMessage = 'ไม่สามารถเชื่อมต่อกับ Server ได้\n\n';
                    
                    if (error.message.includes('Failed to fetch')) {
                        errorMessage += 'สาเหตุที่เป็นไปได้:\n';
                        errorMessage += '• URL ไม่ถูกต้อง\n';
                        errorMessage += '• ยังไม่ได้ Deploy Web App\n';
                        errorMessage += '• การตั้งค่า Deployment ไม่ถูกต้อง\n';
                        errorMessage += '• เกิดปัญหาเครือข่าย';
                    } else if (error.message.includes('HTTP error')) {
                        errorMessage += `เกิดข้อผิดพลาด HTTP: ${error.message}`;
                    } else {
                        errorMessage += error.message;
                    }
                    
                    alert(errorMessage);
                    lucide.createIcons();
                }, 1000);
            }
        }

        // Save GAS URL
        function saveGasUrl() {
            const url = document.getElementById('gas-url').value.trim();
            
            if (!url) {
                alert('กรุณากรอก URL');
                return;
            }

            if (!url.startsWith('https://script.google.com/macros/')) {
                alert('URL ไม่ถูกต้อง กรุณาตรวจสอบรูปแบบ URL');
                return;
            }

            // Save to localStorage
            localStorage.setItem('gasWebAppUrl', url);
            
            // Show success modal
            document.getElementById('success-modal').classList.remove('hidden');
        }

        // Redirect to main app
        function redirectToApp() {
            window.location.href = 'register.html';
        }

        // Enter key support
        document.getElementById('gas-url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testConnection();
            }
        });

        // Auto-save if already tested
        document.getElementById('save-btn').addEventListener('click', saveGasUrl);
    </script>
</body>
</html>
